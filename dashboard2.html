<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
  </head>
  <body>
    <h1>Добро пожаловать на ваш дашбоард</h1>
    <div id="userInfo"></div>
    <form id="weeklyDataForm">
      <label for="weeklyAmount">Недельная сумма:</label><br />
      <input
        type="number"
        id="weeklyAmount"
        name="weeklyAmount"
        required
      /><br />
      <label for="weeklyHours">Часы работы за неделю:</label><br />
      <input type="number" id="weeklyHours" name="weeklyHours" required /><br />
      <button type="submit">Отправить данные за неделю</button>
    </form>
    <form id="dailyIncomeForm">
      <label for="dailyIncome">Дополнительный доход в день:</label><br />
      <input type="number" id="dailyIncome" name="dailyIncome" required /><br />
      <button type="submit">Отправить дополнительный доход в день</button>
    </form>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
      const supabaseUrl = "https://qkmqzhrosivywepflhtq.supabase.co";
      const supabaseKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFrbXF6aHJvc2l2eXdlcGZsaHRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTA3Nzk1NjUsImV4cCI6MjAyNjM1NTU2NX0.8QjJ1W7X0MTS-kPkSr2MzuM3Jjrq8F4H6EYQBEa5a7o";
      const supabaseClient = createClient(supabaseUrl, supabaseKey);

      async function fetchUserInfo() {
        const user = supabaseClient.auth.user();
        if (user) {
          try {
            const { data, error } = await supabaseClient
              .from("users")
              .select("*")
              .eq("id", user.id)
              .single();

            if (data) {
              document.getElementById("userInfo").innerHTML = `
                            <p>Привет, ${user.email}!</p>
                            <p>Ваш ID: ${user.id}</p>
                            <p>Ваше имя: ${data.name}</p>
                        `;
            } else {
              console.error(
                "Ошибка загрузки информации о пользователе:",
                error
              );
            }
          } catch (error) {
            console.error(
              "Ошибка загрузки информации о пользователе:",
              error.message
            );
          }
        } else {
          window.location.href = "index.html";
        }
      }

      async function sendWeeklyData(event) {
        event.preventDefault();
        const weeklyAmount = parseFloat(
          document.getElementById("weeklyAmount").value
        );
        const weeklyHours = parseFloat(
          document.getElementById("weeklyHours").value
        );

        try {
          // Отправляем данные за неделю в Supabase
          const { data, error } = await supabaseClient
            .from("weekly_data")
            .insert([
              {
                weekly_amount: weeklyAmount,
                weekly_hours: weeklyHours,
                user_id: supabaseClient.auth.user().id,
              },
            ]);

          if (error) {
            console.error("Ошибка отправки данных за неделю:", error.message);
          } else {
            console.log("Данные за неделю успешно отправлены:", data);
          }
        } catch (error) {
          console.error("Ошибка отправки данных за неделю:", error.message);
        }
      }

      async function sendDailyIncome(event) {
        event.preventDefault();
        const dailyIncome = parseFloat(
          document.getElementById("dailyIncome").value
        );

        try {
          // Отправляем дополнительный доход в день в Supabase
          const { data, error } = await supabaseClient
            .from("daily_income")
            .insert([
              {
                daily_income: dailyIncome,
                user_id: supabaseClient.auth.user().id,
              },
            ]);

          if (error) {
            console.error(
              "Ошибка отправки дополнительного дохода в день:",
              error.message
            );
          } else {
            console.log("Дополнительный доход в день успешно отправлен:", data);
          }
        } catch (error) {
          console.error(
            "Ошибка отправки дополнительного дохода в день:",
            error.message
          );
        }
      }

      fetchUserInfo();

      document
        .getElementById("weeklyDataForm")
        .addEventListener("submit", sendWeeklyData);
      document
        .getElementById("dailyIncomeForm")
        .addEventListener("submit", sendDailyIncome);
    </script>
  </body>
</html>
